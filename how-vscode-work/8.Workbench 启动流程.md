#### 零、原文链接

https://zhaomenghuan.js.org/blog/vscode-workbench-source-code-interpretation.html#workbench-%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B

#### 一、工作区启动流程

1、src/main.ts
2、真正的入口 startup()

```ts
await import("./vs/code/electron-main/main.js");
```

3、CodeMain 类启动

```ts
startup(){
	// 注入一系列服务
	// 基础服务初始化完成后会加载 IPC 信道并创建 CodeApplication 实例，调用 startup 方法启动 code。
	return instantiationService.createInstance(CodeApplication, mainProcessNodeIpcServer, instanceEnvironment).startup();
}
```

4、CodeApplication 类
CodeApplication.openFirstWindow 最终会根据 environmentService 提供的相关参数（file_uri、folder_uri）调用 windowsMainService.open 方法打开窗口。

```ts
await appInstantiationService.invokeFunction((accessor) =>
	this.openFirstWindow(accessor, initialProtocolUrls)
);

return windowsMainService.open({});
```

4、看 src/vs/platform/windows/electron-main/windowsMainService.ts
实现了 open()方法

```ts
const { windows: usedWindows, filesOpenedInWindow } = await this.doOpen(
	openConfig,
	workspacesToOpen,
	foldersToOpen,
	emptyWindowsWithBackupsToRestore,
	maybeOpenEmptyWindow,
	filesToOpen,
	foldersToAdd,
	foldersToRemove
);
```

doOpen()方法

```ts
addUsedWindow(
	await this.doOpenFolderOrWorkspace(
		openConfig,
		folderToOpen,
		openFolderInNewWindow,
		filesToOpenInWindow
	),
	!!filesToOpenInWindow
);
```

最终调用

```ts
this.openInBrowserWindow({});
```

```ts
// Create the window
mark("code/willCreateCodeWindow");
const createdWindow = (window = this.instantiationService.createInstance(
	CodeWindow,
	{
		state,
		extensionDevelopmentPath: configuration.extensionDevelopmentPath,
		isExtensionTestHost: !!configuration.extensionTestsPath,
	}
));
```

最终
```ts
this._win.loadURL(FileAccess.asBrowserUri(`vs/code/electron-sandbox/workbench/workbench${this.environmentMainService.isBuilt ? '' : '-dev'}.html`).toString(true));
```

最终加载的是这个html文件
src/vs/code/electron-sandbox/workbench/workbench-dev.html
